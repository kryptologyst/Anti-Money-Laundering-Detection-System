name: AML Detection System CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.10, 3.11]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Lint with ruff
      run: |
        pip install ruff
        ruff check src/ tests/ scripts/
    
    - name: Type check with mypy
      run: |
        pip install mypy
        mypy src/ --ignore-missing-imports
    
    - name: Test with pytest
      run: |
        pytest tests/ -v --cov=src --cov-report=xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  data-generation:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: 3.10
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate test data
      run: |
        python scripts/generate_data.py
    
    - name: Verify data generation
      run: |
        python -c "
        import pandas as pd
        import os
        
        # Check if data files exist
        data_files = ['customers.csv', 'transactions.csv', 'relationships.csv', 'features.csv']
        for file in data_files:
            assert os.path.exists(f'data/{file}'), f'Data file {file} not found'
        
        # Check data quality
        customers = pd.read_csv('data/customers.csv')
        transactions = pd.read_csv('data/transactions.csv')
        
        assert len(customers) > 0, 'No customers generated'
        assert len(transactions) > 0, 'No transactions generated'
        assert 'is_suspicious' in transactions.columns, 'Suspicious column missing'
        
        print('Data generation verification passed!')
        "

  model-training:
    runs-on: ubuntu-latest
    needs: [test, data-generation]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: 3.10
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Train models
      run: |
        python scripts/train_models.py
    
    - name: Verify model training
      run: |
        python -c "
        import os
        import pandas as pd
        
        # Check if model results exist
        assert os.path.exists('assets/model_results.csv'), 'Model results not found'
        
        # Check results quality
        results = pd.read_csv('assets/model_results.csv')
        assert len(results) > 0, 'No model results'
        
        # Check if at least one model has reasonable performance
        assert results['f1_score'].max() > 0.5, 'Model performance too low'
        
        print('Model training verification passed!')
        "

  demo-test:
    runs-on: ubuntu-latest
    needs: [test, data-generation]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: 3.10
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test Streamlit demo
      run: |
        python -c "
        import streamlit as st
        import sys
        from pathlib import Path
        
        # Test demo imports
        sys.path.append(str(Path('demo').absolute()))
        
        try:
            # Test if demo can be imported
            import aml_dashboard
            print('Demo import successful')
        except Exception as e:
            print(f'Demo import failed: {e}')
            sys.exit(1)
        "
    
    - name: Test demo functionality
      run: |
        python -c "
        import pandas as pd
        import numpy as np
        
        # Create test data
        test_data = pd.DataFrame({
            'customer_id': ['C1', 'C2'],
            'amount': [1000, 5000],
            'is_suspicious': [0, 1]
        })
        
        # Test basic functionality
        assert len(test_data) == 2
        assert 'is_suspicious' in test_data.columns
        
        print('Demo functionality test passed!')
        "
